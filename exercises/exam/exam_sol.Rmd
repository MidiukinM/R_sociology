---
title: "Экзамен: решение"
output: 
  html_document:
    highlight: pygments
editor_options: 
  chunk_output_type: console
---
<style>
h1,
h2,
h3,
h4,
h5,
h6  {
  color: #317eac;
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

### Задание №0 

```{r}
# packages <- c('readr', 'dplyr', 'tidyr', 'ggplot2', 'DescTools')
# install.packages(packages)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(DescTools)
```

Подгрузите ваш датасет.

```{r}
url <- 'https://raw.githubusercontent.com/MidiukinM/R_sociology/main/exercises/exam/data/data.csv'
df <- read_csv(url)
```

Это датасет, в котором находится информация о стоимости квартир в Москве.

* `price` – цена квартиры в $1000
* `totsp` – общая площадь квартиры, кв.м.
* `livesp` – жилая площадь квартиры, кв.м.
* `kitsp` – площадь кухни, кв.м.
* `dist` – расстояние от центра в км.
* `metrdist` – расстояние до метро в минутах
* `walk` – 1 – пешком от метро, 0 – на транспорте
* `brick` – 1 – кирпичный, монолит ж/б, 0 – другой
* `floor` – 1 – этаж кроме первого и последнего, 0 – иначе.
* `code` – число от 1 до 8, определяющее район Москвы:
1. Cевер, вокруг Калужско-Рижской линии метрополитена
2. Север, вокруг Серпуховско-Тимирязевской линии метрополитена
3. Северо-запад, вокруг Замоскворецкой линии метрополитена
4. Северо-запад, вокруг Таганско-Краснопресненской линии метрополитена
5. Юго-восток, вокруг Люблинской линии метрополитена
6. Юго-восток, вокруг Таганско-Краснопресненской линии метрополитена
7. Восток, вокруг Калиниской линии метрополитена
8. Восток, вокруг Арбатско-Покровской линии метрополитена

В датасете нет пропущенных значений Не нужно беспокоиться об этом.

### Задание №1 (30 баллов)

Построить 95% и 99% асимптотические доверительные интервалы для средней стоимости квартир в Москве. Доверительные интервалы строить вручную, без встроенной функции для нахождения доверительного интервала.

```{r}
my_confint <- function(x, alpha){
  hat_mean <- mean(x)
  hat_sd <- sd(x)
  n <- length(x)
  
  left_cr <- qnorm(alpha/2)
  right_cr <- qnorm((1-alpha) + alpha/2)
  
  left_ci <- hat_mean + left_cr * hat_sd / n^(1/2)
  right_ci <- hat_mean + right_cr * hat_sd / n^(1/2)
  
  cat('Доверительный интервал', 1-alpha, '% от', left_ci, 'до', right_ci)
}

my_confint(df$price, 0.05)
my_confint(df$price, 0.01)

```

### Задание №2 (30 баллов)

Постройте на одном графике (разными цветами) гистограмму распределения цены для района с кодом 2 (`code = 2`) и района с кодом 3 (`code = 3`). Какие выводы вы можете сделать по этим графикам?

```{r}
df %>%
  select(price, code) %>%
  filter(code %in% c(2, 3)) %>%
  ggplot(aes(y = price, x = factor(code))) +
  geom_violin(fill='darkblue') + 
  xlab("Код района") + 
  ylab("Цена") + 
  labs(title = "Распределение цены в двух районах")
```

Выводы:  
1. Цены у 2 района сосредоточены около 100 тыс. долл, здесь лежит основная масса квартир. Есть отдельные квартиры-выбросы, достигающие 300 тыс. долл., но их не так много. 
2. Распределение цен у 3-го района более вытянутое, основная масса квартир с ценой от 90 до 250 тыс. долл., то есть разброс (дисперсия) цен намного выше в сравнении со 2ым районом. Также видим очень очень длинный хвост до 500 тыс. долл. каких-то отдельных квартир, возможно в районе находится элитный жк, который портит всю статистику. 


### Задание №3 (40 баллов)

Проверить гипотезу, что ровно половина квартир в Москве находится в 10 минутах от метро **пешком**. 

$$
\begin{aligned}
&H_0: \hspace{2mm} p = 0.5 \hspace{2mm} \text{Половина квартир в 10 минутах от метро пешком} \\
&H_A: \hspace{2mm} p < 0.5  \hspace{2mm} \text{Меньше половины квартир в 10 минутах от метро пешком}
\end{aligned}
$$
**Готовим выборку**

```{r}
df2 <- df %>% 
    # берем только пешком
    filter(walk == 1) %>% 
    # TRUE (1) - живет в 10 минутах, FALSE (0) - дальше
    mutate(is_near = metrdist <= 10)

# выборка для гипотезы:
x <- df2$is_near
```

**Проверяем гипотезу вручную** 

Распределение Бернулли, у него в точности знаем параметры:

$$
\begin{aligned}
&E(X) = p \\
&Var(X) = p \cdot (1-p)
\end{aligned}
$$
Следовательно гипотезу проверяем по следующему критерию: 

$$
\begin{aligned}
&\hat{p} \sim N(E(X), \frac{Var(X)}{n}) \\
&\hat{p} \sim N(p, \frac{p\cdot(1-p)}{n}) \\
&\frac{\hat{p} - p}{\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}} \sim N(0, 1) \\
\end{aligned}
$$

```{r}
p_hat <- mean(x)
p_h0 <- 0.5
var_hat <- p_hat * (1-p_hat) # можно было бы и просто var(x) - но это менее точно
n <- length(x)

stat <- (p_hat - p_h0) / (var_hat / n)^(1/2)

# Находим критическое значение (гипотеза левосторонняя!!)
alpha <- 0.05

left_cr <- qnorm(alpha)

if (stat > left_cr){
  print("Гипотеза не отвергается")
} else {
   print("Гипотеза отвергается")
}

```

Замечание: можно было вместо $p(1-p)$ просто взять выборчную дисперсию от выборки `var(x)`, тогда рассуждения выше были бы не нужны. 

**Через встроенную функцию**

```{r}
p_hat <- mean(x)
p_h0 <- 0.5
var_hat <- p_hat * (1-p_hat) # можно было бы и просто var(x) - но это менее точно
n <- length(x)

ZTest(x = x, alternative = "less", 
      mu = 0.5, sd_pop = var_hat^(1/2), conf.level = 0.95)
```

Гипотеза не отвергается (p-value = 1, z-stat = 34.264)

Замечание: можно заметить, что тест выдал ту же z-stat, которую мы нашли вручную

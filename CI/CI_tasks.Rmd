---
title: "Задачи на доверительные интервалы"
output: 
  html_document:
    css: ../css/style.css
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    highlight: pygments
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Ваня смотрит игру престолов 

<center>
![](./pictures/game.jpeg){width=300px}
</center>

Ваня очень любит сериалы и иногда тратит на них много времени. Сильнее всего Ваню привлекла "Игра престолов", из-за которой в какой-то момент он пропустил дедлайн по домашке. Ваня очень расстроился и решил оценить, сколько времени в среднем он тратит на просмотр этого сериала. Давайте поможем ему это сделать. Для этого возьмем 10 случайных дней в периоде, когда Ваня интересовался Игрой престолов и посмотрим, сколько серий он в эти дни посмотрел. А затем на основе этих данных посчитаем среднее. 

```{r}
x <- c(3, 2, 5, 5, 1, 0, 0, 3)

mean(x)
```

Получается, что Ваня в среднем смотрит 2.375 серий в день, но можем ли мы по этому числу честно судить о потраченном времени Вани? А если бы к нам в выборку попали бы другие 10 дней и по ним мы бы получили среднее 4.2? Какому числу верить? 

Именно поэтому имеет смысл не просто посчитать статистику по выборке, но и построить для нее доверительный интервал, чтобы увидеть, а **в каких диапазонах вообще вот это среднее может меняться**? Давайте построим доверительный интервал, используя наши имеющиеся знания. Разделим алгоритм на несколько шагов: 

### Шаг №1: Задаем случайную величину 

$X$ - кол-во серий, которые посмотрел Ваня

### Шаг №2: Определяем распределение $X$

Помним, что такие случайные величины, как счетчики (то есть например, число лайков) можно описывать распределением Пуассона. Получается, что: 

$X \sim Poiss(\lambda)$, где $\lambda$ - интенсивность, с которой Ваня смотрит сериал.

### Шаг №3: Смотрим на характеристики нашего распределения

Знаем, что: 

$$
\begin{aligned}
&E(X) = \lambda \\
&Var(X) = \lambda
\end{aligned}
$$

Ага, раз мат. ожидание нашей случайной величины это $\lambda$, а мат. ожидание это и есть среднее число серий, то получается что если мы хотим построить доверительный интервал для среднего, то это тоже самое, что построить доверительный интервал для $\lambda$

### Шаг №4: Определяем распределение $\bar x$

Строить доверительный интервал мы будем для среднего. Для этого нам нужно знать его распределение. Как только мы поймем, как оно выглядит, мы сможем найти критические значения, причем такие критические значения, чтобы в диапазоне, которые они задают, лежало 95% наших средних, которые мы можем получить. 

Как же распределено наше $\bar x$? Ответ на этот вопрос говорит нам Центральная Предельная Теорема: 

$$
\hat \lambda = \bar x \overset{asy}{\sim} N\left(E(X), \frac{Var(X)}{n}\right).
$$

$E(X)$ и $Var(X)$ мы знаем, мы нашли их на шаге №3, следовательно мы можем подставить их в наше распределение. 

$$
\hat \lambda = \bar x \overset{asy}{\sim} N\left(\lambda, \frac{\lambda}{n}\right)
$$

Ну а теперь осталось сделать пару нехитрых манипуляций, чтобы получить нормальное распределение ни с какими-то странными штуками в качестве параметров, а с понятными параметрами, которые мы можем построить: 

$$
\frac{\hat \lambda - \lambda}{\sqrt{\frac{\hat \lambda}{n}}} \overset{asy}{\sim} N (0,1)
$$

Окей, теперь мы знаем что вот такая хрень, как $\frac{\hat \lambda - \lambda}{\sqrt{\frac{\hat \lambda}{n}}}$ распределена нормально с параметрами 0 и 1, а значит для этой штуки мы можем найти критические значения которые дают нам $95\%$ интервал. Можем найти их в R с помощью функции `qnorm()`

```{r}
alpha = 1 - 0.95
print(qnorm(alpha/2))
print(qnorm(0.95 + alpha/2))
```

Получается, что: 
$$
P \left( -1.96 \le \frac{\hat \lambda - \lambda}{\sqrt{\frac{\hat \lambda}{n}}}  \le 1.96 \right) = 0.95
$$

Преобразовав неравенство так, чтобы по центру остался неизвестный параметр, доверительный интервал для которого мы строим (то есть $\lambda$), получаем: 

$$
P \left( \hat \lambda + (- 1.96) \cdot \sqrt{\frac{\hat \lambda}{n}} \le \lambda \le \hat \lambda + 1.96 \cdot \sqrt{\frac{\hat \lambda}{n}} \right) = 0.95
$$

Ну и наконец можем построить доверительный интервал в R: 

```{r}
# выборка
x <- c(5, 8, 7, 8, 2, 3, 1, 2, 10, 12)

# lambda с крышкой - то есть среднее, посчитанное по выборке
lam_hat = mean(x)

# уровень значимости alpha
alpha = 1 - 0.95    

# левая и правая критические точки
z_left = qnorm(alpha/2)
z_right = qnorm(0.95 + alpha/2)

# стандратное отклонение
lam_se = sqrt(lam_hat / length(x))

# границы интервала
lam_left = lam_hat + z_left * lam_se
lam_right = lam_hat + z_right * lam_se
cat('Доверительный интервал:', lam_left, lam_right)
```

**Вопросы на понимание:**

1. Зачем нам нужно было ЦПТ? Могли бы мы обойтись без него?  
2. Что поменяется, если распределение будет не Пуассона, а Бернулли?   
3. Зачем вообще строить доверительный интервал? 

## 2. Аварии на шахтах

<center>
![](./pictures/tunnel.jpeg){width=300px}
</center>

На угольных шахтах ежегодно происходят аварии. Англия довольно давно [собирает информацию](https://github.com/FUlyankin/matstat_online/blob/master/data/coals.csv) о числе крупных аварий. Именно её нам предстоит проанализировать:

* хочется понять как часто в среднем происходят аварии 
* насколько большой у среднего числа аварий доверительный интервал

```{r}
library("readr")
library("dplyr")
library("ggplot2")
```

```{r}
df = read_csv('data/coals.txt')
df = df %>% select(year, count)
head(df)
```

Посмотрим на распределение числа аварий. 

```{r}
qplot(df$count)
```

Судя по гистограмме уместно предположить, что число аварий имеет распределение Пуассона, $Poiss(\lambda)$.  То есть, если мы хотим что-то понять про среднее число аварий, нам надо оценить параметр $\lambda$. Делаем тоже самое

```{r}
# выборка
x <- df$count

# lambda с крышкой - то есть среднее, посчитанное по выборке
lam_hat = mean(x)

# уровень значимости alpha
alpha = 1 - 0.95    

# левая и правая критические точки
z_left = qnorm(alpha/2)
z_right = qnorm(0.95 + alpha/2)

# стандратное отклонение
lam_se = sqrt(lam_hat / length(x))

# границы интервала
lam_left = lam_hat + z_left * lam_se
lam_right = lam_hat + z_right * lam_se
cat('Доверительный интервал:', lam_left, lam_right)
```

**Важное замечание:** 

На самом деле если обобщать процесс построения доверительного интервала для среднего по выборке любого распределения, то можно пользоваться следующей формулой: 

$$
P \left( \bar x + (- 1.96) \cdot \sqrt{\frac{\hat{Var}}{n}} \le E(X) \le \bar x + 1.96 \cdot \sqrt{\frac{\hat{Var}}{n}} \right) = 0.95
$$

То есть: 

```{r}
# выборка
x <- df$count

# среднее, посчитанное по выборке
hat_mean = mean(x)

# СКО (корень из дисперсии), посчитанный по выборке 
hat_sd = sd(x)

# уровень значимости alpha
alpha = 1 - 0.95    

# левая и правая критические точки
z_left = qnorm(alpha/2)
z_right = qnorm(0.95 + alpha/2)

# стандратное отклонение

# границы интервала
left = hat_mean + z_left * (hat_sd / sqrt(length(x)))
right = hat_mean + z_right * (hat_sd / sqrt(length(x)))
cat('Доверительный интервал:', left, right)
```
